<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jogos Pedag√≥gicos - Capi Games</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { box-sizing: border-box; }
    @keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}
    @keyframes dance{0%,100%{transform:rotate(0) scale(1)}25%{transform:rotate(-5deg) scale(1.1)}50%{transform:rotate(5deg) scale(1.1)}75%{transform:rotate(-3deg) scale(1.05)}}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    .bounce{animation:bounce 2s infinite}
    .dance{animation:dance 1s ease-in-out}
    .float{animation:float 3s ease-in-out infinite}
    .speech-bubble{position:relative;background:#fff;border-radius:20px;padding:15px;margin:10px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
    .speech-bubble:after{content:'';position:absolute;bottom:-10px;left:30px;border:10px solid transparent;border-top-color:#fff}
    .age-card{transition:all .3s ease;cursor:pointer}
    .age-card:hover{transform:translateY(-5px);box-shadow:0 10px 25px rgba(0,0,0,.15)}
    .game-preview{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:15px;padding:20px;color:#fff;text-align:center;cursor:pointer;transition:transform .3s ease}
    .game-preview:hover{transform:scale(1.05)}
  </style>
</head>
<body class="min-h-full bg-gradient-to-br from-blue-400 via-purple-500 to-pink-400">

  <!-- Header -->
  <header class="bg-white/90 backdrop-blur-sm shadow-lg sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <img src="https://www.riopreto.sp.leg.br/Content/css/images/logo-1.png" alt="Logo C√¢mara Municipal" class="h-12 w-auto" onerror="this.src=''; this.alt=''; this.style.display='none';">
        <h1 class="text-3xl font-bold text-purple-600 uppercase">CAPI GAMES</h1>
      </div>
      <div class="flex items-center space-x-4">
        <button id="toggleCapi" class="bg-yellow-400 hover:bg-yellow-500 text-purple-800 font-bold py-2 px-4 rounded-full transition-colors">
          <span id="capiToggleText">üêπ DESABILITAR CAPI</span>
        </button>
        <button id="reindexBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full">
          üîÑ ATUALIZAR JOGOS
        </button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">

    <!-- Boas-vindas -->
    <div class="text-center mb-8">
      <h2 class="text-5xl font-bold text-white mb-4 drop-shadow-lg">BEM-VINDOS AO MUNDO DOS JOGOS!</h2>
      <p class="text-xl text-white/90 max-w-3xl mx-auto drop-shadow uppercase">
        Explore, aprenda e divirta-se com jogos educativos organizados por pastas e categorias!
      </p>
    </div>

    <!-- Busca -->
    <div class="max-w-4xl mx-auto mb-8 bg-white/95 backdrop-blur-sm rounded-3xl p-6 shadow-2xl">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">PALAVRA-CHAVE</label>
          <input id="q" type="text" placeholder="Digite aqui..." class="w-full p-3 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none uppercase">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">CATEGORIA (PASTA)</label>
          <select id="categoryFilter" class="w-full p-3 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none">
            <option value="">Todas</option>
          </select>
        </div>
        <div class="flex items-end gap-2">
          <button id="clearBtn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full transition-colors">üóëÔ∏è Limpar</button>
        </div>
      </div>
    </div>

    <!-- Lista din√¢mica por categoria -->
    <div id="catalog" class="space-y-10"></div>

    <!-- Mascote -->
    <div id="capiContainer" class="fixed bottom-8 right-8 z-40">
      <div id="capiSpeech" class="speech-bubble hidden mb-4 max-w-xs">
        <p id="capiMessage" class="text-purple-800 font-semibold"></p>
      </div>
      <div id="capi" class="float cursor-pointer bg-orange-400 rounded-full p-4 shadow-2xl hover:bg-orange-500 transition-colors">
        <svg width="80" height="80" viewBox="0 0 100 100" class="text-white">
          <ellipse cx="50" cy="60" rx="35" ry="25" fill="#8B4513"/>
          <ellipse cx="50" cy="35" rx="25" ry="20" fill="#A0522D"/>
          <ellipse cx="35" cy="25" rx="8" ry="12" fill="#8B4513"/>
          <ellipse cx="65" cy="25" rx="8" ry="12" fill="#8B4513"/>
          <circle cx="42" cy="32" r="4" fill="white"/><circle cx="58" cy="32" r="4" fill="white"/>
          <circle cx="42" cy="32" r="2" fill="black"/><circle cx="58" cy="32" r="2" fill="black"/>
          <ellipse cx="50" cy="40" rx="3" ry="2" fill="black"/>
          <path d="M45 45 Q50 48 55 45" stroke="black" stroke-width="2" fill="none"/>
          <ellipse cx="35" cy="80" rx="6" ry="8" fill="#8B4513"/>
          <ellipse cx="50" cy="80" rx="6" ry="8" fill="#8B4513"/>
          <ellipse cx="65" cy="80" rx="6" ry="8" fill="#8B4513"/>
        </svg>
      </div>
    </div>

    <!-- Modal simples de progresso -->
    <div id="progressModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
      <div class="bg-white rounded-3xl max-w-xl w-full overflow-hidden shadow-2xl">
        <div class="bg-gradient-to-r from-green-500 to-emerald-600 p-6 text-white">
          <div class="flex items-center justify-between">
            <h3 class="text-2xl font-bold">üîÑ Indexando Jogos</h3>
            <button id="closeProgress" class="bg-white/20 hover:bg-white/30 rounded-full p-2">&times;</button>
          </div>
        </div>
        <div class="p-6">
          <div class="bg-gray-200 rounded-full h-4 mb-2">
            <div id="progressBar" class="bg-green-500 h-4 rounded-full transition-all duration-300" style="width:0%"></div>
          </div>
          <p id="progressText" class="text-center text-sm text-gray-600">Preparando...</p>
        </div>
      </div>
    </div>

  </main>

  <script>
    /*** CONFIGURA√á√ÉO ***/
    // true = usa GitHub API para espelhar exatamente a estrutura do reposit√≥rio
    // false = ignora GitHub e usa manifest local games-manifest.json (raiz do site)
    const USE_GITHUB_INDEX = true;

    const GITHUB = {
      owner: "educacaodigital",
      repo:  "capigames",
      branch:"main",
      apiBase: "https://api.github.com",
    };

    // Excluir arquivos/pastas do √≠ndice
    const EXCLUDE_FILES  = new Set(["index.html", ".DS_Store", "README.md"]);
    const EXCLUDE_FOLDERS= new Set([".git", ".github", "assets", "static", "img", "images", "css", "js"]);

    /*** VARS ***/
    let capiEnabled = true;
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>document.querySelectorAll(sel);
    const catalogEl = $("#catalog");
    const qEl = $("#q");
    const categoryFilterEl = $("#categoryFilter");
    const reindexBtn = $("#reindexBtn");
    const clearBtn = $("#clearBtn");

    const progressModal = $("#progressModal");
    const progressBar   = $("#progressBar");
    const progressText  = $("#progressText");
    const closeProgress = $("#closeProgress");

    // Estado do √≠ndice
    let indexEntries = []; // {category, path, title, href}
    let categories   = new Set();

    /*** UI Helpers ***/
    function showCapiMessage(message){
      if(!capiEnabled) return;
      const speech = $("#capiSpeech");
      const msg = $("#capiMessage");
      msg.textContent = message;
      speech.classList.remove("hidden");
      setTimeout(()=>speech.classList.add("hidden"), 2600);
    }
    $("#capi").addEventListener("click", function(){
      if(!capiEnabled) return;
      this.classList.add("dance");
      setTimeout(()=>this.classList.remove("dance"), 1000);
      showCapiMessage("Vamos jogar? üéÆ");
    });
    $("#toggleCapi").addEventListener("click", ()=>{
      capiEnabled = !capiEnabled;
      const cont = $("#capiContainer");
      const t = $("#capiToggleText");
      if(capiEnabled){
        cont.style.display = "block";
        t.textContent = "üêπ DESABILITAR CAPI";
        showCapiMessage("Opa! Voltei! üòÑ");
      }else{
        cont.style.display = "none";
        t.textContent = "üêπ HABILITAR CAPI";
      }
    });

    function openProgress(msg="Iniciando..."){
      progressText.textContent = msg;
      progressBar.style.width = "0%";
      progressModal.classList.remove("hidden");
      progressModal.classList.add("flex");
    }
    function updateProgress(pct, msg){
      progressBar.style.width = pct + "%";
      if(msg) progressText.textContent = msg;
    }
    function closeProgressModal(){
      progressModal.classList.add("hidden");
      progressModal.classList.remove("flex");
    }
    closeProgress.addEventListener("click", closeProgressModal);

    /*** FETCH GitHub ***/
    async function ghListDir(path=""){
      // GET /repos/{owner}/{repo}/contents/{path}?ref=branch
      const url = `${GITHUB.apiBase}/repos/${GITHUB.owner}/${GITHUB.repo}/contents/${encodeURIComponent(path)}?ref=${GITHUB.branch}`;
      const res = await fetch(url, {headers:{Accept:"application/vnd.github.v3+json"}});
      if(!res.ok) throw new Error("Falha ao acessar GitHub contents: " + path);
      return res.json(); // array de items {name,path,download_url,type}
    }

    async function ghWalkTree(basePath="", accumulator=[]){
      const items = await ghListDir(basePath);
      for(const item of items){
        if(item.type === "dir"){
          if(EXCLUDE_FOLDERS.has(item.name)) continue;
          await ghWalkTree(item.path, accumulator);
        }else if(item.type === "file"){
          const nameLower = item.name.toLowerCase();
          if(!nameLower.endsWith(".html")) continue;
          if(EXCLUDE_FILES.has(item.name)) continue;
          accumulator.push(item.path);
        }
      }
      return accumulator;
    }

    /*** Leitura de <title> de um arquivo HTML ***/
    async function readHtmlTitleByUrl(url){
      try{
        const res = await fetch(url,{cache:"no-store"});
        if(!res.ok) return null;
        const text = await res.text();
        const m = text.match(/<title[^>]*>([\s\S]*?)<\/title>/i);
        return m ? m[1].trim() : null;
      }catch{
        return null;
      }
    }

    async function readHtmlTitleLocal(path){
      // tenta via fetch relativo (servidor local precisa servir o arquivo)
      return readHtmlTitleByUrl(path);
    }

    /*** Constru√ß√£o do √≠ndice ***/
    function pathToCategory(path){
      // Categoria = primeira pasta do caminho
      const parts = path.split("/").filter(Boolean);
      return parts.length>1 ? parts[0] : "(raiz)";
    }

    function toRawUrl(path){
      // URL crua do GitHub para ler o HTML (CORS habilitado)
      return `https://raw.githubusercontent.com/${GITHUB.owner}/${GITHUB.repo}/${GITHUB.branch}/${path}`;
    }

    async function buildIndexFromGitHub(){
      openProgress("Lendo estrutura do GitHub...");
      const files = await ghWalkTree("");
      if(files.length===0) throw new Error("Nenhum arquivo .html encontrado no reposit√≥rio.");

      indexEntries = [];
      let done=0;
      for(const filePath of files){
        const cat = pathToCategory(filePath);
        categories.add(cat);
        const rawUrl = toRawUrl(filePath);
        const title = await readHtmlTitleByUrl(rawUrl) || filePath.split("/").pop().replace(/\.html?$/i,"");
        indexEntries.push({
          category: cat,
          path: filePath,
          title: title,
          href: filePath // o link relativo funciona se a estrutura local espelhar a do GitHub
        });
        done++;
        if(done%5===0) updateProgress(Math.round((done/files.length)*100), `Indexando (${done}/${files.length})...`);
      }
      updateProgress(100, "Conclu√≠do!");
      closeProgressModal();
    }

    async function buildIndexFromLocalManifest(){
      openProgress("Lendo games-manifest.json local...");
      const res = await fetch("games-manifest.json",{cache:"no-store"});
      if(!res.ok) throw new Error("games-manifest.json n√£o encontrado na raiz.");
      const manifest = await res.json();
      const files = (manifest.entries||[]).map(e=>e.path).filter(p=>p.toLowerCase().endsWith(".html") && !/\/?index\.html?$/i.test(p));
      if(files.length===0) throw new Error("Manifesto sem arquivos .html v√°lidos.");

      indexEntries = [];
      let done=0;
      for(const filePath of files){
        const cat = pathToCategory(filePath);
        categories.add(cat);
        const title = await readHtmlTitleLocal(filePath) || filePath.split("/").pop().replace(/\.html?$/i,"");
        indexEntries.push({
          category: cat,
          path: filePath,
          title: title,
          href: filePath
        });
        done++;
        if(done%5===0) updateProgress(Math.round((done/files.length)*100), `Indexando (${done}/${files.length})...`);
      }
      updateProgress(100, "Conclu√≠do!");
      closeProgressModal();
    }

    async function buildIndex(){
      categories = new Set();
      indexEntries = [];
      try{
        if(USE_GITHUB_INDEX){
          await buildIndexFromGitHub();
        }else{
          await buildIndexFromLocalManifest();
        }
        renderFilters();
        renderCatalog();
        showCapiMessage("√çndice atualizado com sucesso! ‚úÖ");
      }catch(err){
        closeProgressModal();
        console.warn(err);
        // Fallback autom√°tico: se GitHub falhar, tenta manifest local
        if(USE_GITHUB_INDEX){
          try{
            await buildIndexFromLocalManifest();
            renderFilters();
            renderCatalog();
            showCapiMessage("Sem GitHub. Usei o manifest local. üìÑ");
          }catch(err2){
            console.error(err2);
            alert("N√£o foi poss√≠vel construir o √≠ndice (GitHub e manifest local indispon√≠veis).");
            showCapiMessage("Erro ao indexar. ‚ùå");
          }
        }else{
          alert("N√£o foi poss√≠vel construir o √≠ndice a partir do manifest local.");
          showCapiMessage("Erro ao indexar. ‚ùå");
        }
      }
    }

    /*** Renderiza√ß√£o ***/
    function renderFilters(){
      // Categoria
      const cats = Array.from(categories).sort((a,b)=>a.localeCompare(b,'pt-BR'));
      categoryFilterEl.innerHTML = `<option value="">Todas</option>` + cats.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
    }

    function groupByCategory(entries){
      const map = new Map();
      for(const e of entries){
        if(!map.has(e.category)) map.set(e.category, []);
        map.get(e.category).push(e);
      }
      // ordena cada grupo por t√≠tulo
      for(const [k,arr] of map){
        arr.sort((a,b)=>a.title.localeCompare(b.title,'pt-BR'));
      }
      return map;
    }

    function renderCatalog(){
      const q = (qEl.value||"").trim().toUpperCase();
      const catFilter = categoryFilterEl.value;

      let filtered = indexEntries.filter(e=>{
        const inCat = !catFilter || e.category===catFilter;
        const inText = !q || e.title.toUpperCase().includes(q) || e.path.toUpperCase().includes(q);
        return inCat && inText;
      });

      const grouped = groupByCategory(filtered);
      const sections = [];

      if(filtered.length===0){
        catalogEl.innerHTML = `
          <div class="text-center py-10 text-white/90">
            <div class="text-5xl mb-3">üòî</div>
            <p class="text-2xl font-bold drop-shadow">Nenhum jogo encontrado</p>
            <p>Tente alterar os filtros ou a palavra-chave.</p>
          </div>`;
        return;
      }

      for(const [category, items] of grouped){
        sections.push(`
          <section class="bg-white/90 backdrop-blur-sm rounded-3xl p-6 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-2xl font-bold text-purple-600">${escapeHtml(category)}</h3>
              <span class="text-sm text-gray-600">${items.length} jogo(s)</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              ${items.map(renderCard).join("")}
            </div>
          </section>
        `);
      }
      catalogEl.innerHTML = sections.join("\n");
    }

    function renderCard(item){
      // link direto para o arquivo local (estrutura espelhada do GitHub)
      return `
      <a href="${encodeURI(item.href)}" class="game-preview block" title="${escapeHtml(item.path)}">
        <div class="text-5xl mb-3">üéÆ</div>
        <h4 class="text-xl font-bold mb-1">${escapeHtml(item.title)}</h4>
        <p class="text-xs opacity-90">${escapeHtml(item.path)}</p>
      </a>`;
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    }

    /*** Eventos ***/
    qEl.addEventListener("input", ()=>renderCatalog());
    categoryFilterEl.addEventListener("change", ()=>renderCatalog());
    clearBtn.addEventListener("click", ()=>{
      qEl.value = ""; categoryFilterEl.value = "";
      renderCatalog();
    });
    reindexBtn.addEventListener("click", ()=>buildIndex());

    // inicia
    buildIndex();
  </script>
</body>
</html>
