<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Capi Games ‚Äî Cat√°logo de Jogos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{box-sizing:border-box}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    .float{animation:float 3s ease-in-out infinite}
    .bubble{position:relative;background:#fff;border-radius:16px;padding:12px;margin:8px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
    .bubble:after{content:'';position:absolute;bottom:-10px;left:24px;border:10px solid transparent;border-top-color:#fff}
    .card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:14px;padding:18px;color:#fff;text-align:center;transition:transform .2s ease}
    .card:hover{transform:scale(1.03)}
  </style>
</head>
<body class="min-h-full bg-gradient-to-br from-blue-400 via-purple-500 to-pink-400">

  <!-- Header -->
  <header class="bg-white/90 backdrop-blur-sm shadow-lg sticky top-0 z-50">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-extrabold text-purple-700 uppercase tracking-wide">Capi Games</h1>
      <div class="flex items-center gap-2">
        <button id="reindexBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full">
          üîÑ Atualizar Jogos
        </button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">

    <!-- Busca / Filtros -->
    <section class="bg-white/95 backdrop-blur-sm rounded-3xl p-6 shadow-2xl max-w-4xl mx-auto">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Palavra-chave</label>
          <input id="q" type="text" placeholder="Digite aqui..." class="w-full p-3 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none uppercase">
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Categoria</label>
          <select id="categoryFilter" class="w-full p-3 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none">
            <option value="">Todas</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="clearBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-full">üóëÔ∏è Limpar</button>
        </div>
      </div>
    </section>

    <!-- Cat√°logo -->
    <section id="catalog" class="space-y-8 mt-8"></section>

    <!-- Mascote -->
    <div id="capiContainer" class="fixed bottom-6 right-6">
      <div id="capiSpeech" class="bubble hidden max-w-xs">
        <p id="capiMessage" class="text-purple-800 font-semibold"></p>
      </div>
      <div id="capi" class="float cursor-pointer bg-orange-400 rounded-full p-3 shadow-2xl hover:bg-orange-500">
        <svg width="72" height="72" viewBox="0 0 100 100">
          <ellipse cx="50" cy="60" rx="35" ry="25" fill="#8B4513"/>
          <ellipse cx="50" cy="35" rx="25" ry="20" fill="#A0522D"/>
          <ellipse cx="35" cy="25" rx="8" ry="12" fill="#8B4513"/>
          <ellipse cx="65" cy="25" rx="8" ry="12" fill="#8B4513"/>
          <circle cx="42" cy="32" r="4" fill="white"/><circle cx="58" cy="32" r="4" fill="white"/>
          <circle cx="42" cy="32" r="2" fill="black"/><circle cx="58" cy="32" r="2" fill="black"/>
          <ellipse cx="50" cy="40" rx="3" ry="2" fill="black"/>
          <path d="M45 45 Q50 48 55 45" stroke="black" stroke-width="2" fill="none"/>
          <ellipse cx="35" cy="80" rx="6" ry="8" fill="#8B4513"/>
          <ellipse cx="50" cy="80" rx="6" ry="8" fill="#8B4513"/>
          <ellipse cx="65" cy="80" rx="6" ry="8" fill="#8B4513"/>
        </svg>
      </div>
    </div>

    <!-- Modal de Progresso -->
    <div id="progressModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
      <div class="bg-white rounded-3xl max-w-xl w-full overflow-hidden shadow-2xl">
        <div class="bg-gradient-to-r from-green-500 to-emerald-600 p-6 text-white">
          <div class="flex items-center justify-between">
            <h3 class="text-2xl font-bold">üîÑ Indexando Jogos</h3>
            <button id="closeProgress" class="bg-white/20 hover:bg-white/30 rounded-full p-2">&times;</button>
          </div>
        </div>
        <div class="p-6">
          <div class="bg-gray-200 rounded-full h-3 mb-2">
            <div id="progressBar" class="bg-green-500 h-3 rounded-full transition-all duration-300" style="width:0%"></div>
          </div>
          <p id="progressText" class="text-center text-sm text-gray-600">Preparando...</p>
        </div>
      </div>
    </div>

  </main>

  <script>
    /* =======================
       CONFIGURA√á√ÉO DO INDEXADOR
       ======================= */

    // true -> Indexa direto do GitHub (estrutura oficial)
    // false -> Usa games-manifest.json local (raiz do site)
    const USE_GITHUB_INDEX = true;

    const GITHUB = {
      owner:  "educacaodigital",
      repo:   "capigames",
      branch: "main",
      api:    "https://api.github.com",
      raw:    "https://raw.githubusercontent.com"
    };

    // Categorias v√°lidas e labels
    const CATEGORY_ORDER = ["1-3","4-5","6-10","11-14","naee"];
    const CATEGORY_LABELS = {
      "1-3":  "1 a 3 anos",
      "4-5":  "4 e 5 anos",
      "6-10": "6 a 10 anos",
      "11-14":"11 a 14 anos",
      "naee": "Sala de Recursos"
    };

    const EXCLUDE_FILES   = new Set(["index.html",".DS_Store","README.md"]);
    const EXCLUDE_FOLDERS = new Set([".git",".github","assets","static","img","images","css","js"]);

    // Estado
    let indexEntries = []; // {category, path, title, href}
    let presentCategories = new Set();

    // UI refs
    const $  = (s)=>document.querySelector(s);
    const qEl = $("#q");
    const categoryFilterEl = $("#categoryFilter");
    const catalogEl = $("#catalog");
    const reindexBtn = $("#reindexBtn");
    const clearBtn = $("#clearBtn");
    const progressModal = $("#progressModal");
    const progressBar = $("#progressBar");
    const progressText = $("#progressText");
    $("#closeProgress").addEventListener("click", ()=>{progressModal.classList.add("hidden"); progressModal.classList.remove("flex");});

    // Mascote
    $("#capi").addEventListener("click", ()=>showMsg("Vamos explorar os jogos! üéÆ"));
    function showMsg(t){
      $("#capiMessage").textContent = t;
      const s = $("#capiSpeech");
      s.classList.remove("hidden");
      setTimeout(()=>s.classList.add("hidden"), 2400);
    }

    /* =======================
       UTILIT√ÅRIOS
       ======================= */

    function openProgress(msg="Iniciando..."){ progressText.textContent=msg; progressBar.style.width="0%"; progressModal.classList.remove("hidden"); progressModal.classList.add("flex"); }
    function updateProgress(p, msg){ progressBar.style.width = p + "%"; if(msg) progressText.textContent = msg; }
    function closeProgress(){ progressModal.classList.add("hidden"); progressModal.classList.remove("flex"); }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m])); }

    function firstFolder(path){
      const parts = path.split("/").filter(Boolean);
      return parts.length>1 ? parts[0].toLowerCase() : "";
    }

    function normalizeCategoryFromPath(path){
      const root = firstFolder(path);
      // somente as 5 v√°lidas; outras s√£o ignoradas
      if (CATEGORY_ORDER.includes(root)) return root;
      return null;
    }

    function toRawUrl(path){
      return `${GITHUB.raw}/${GITHUB.owner}/${GITHUB.repo}/${GITHUB.branch}/${path}`;
    }

    async function fetchDir(path=""){
      const url = `${GITHUB.api}/repos/${GITHUB.owner}/${GITHUB.repo}/contents/${encodeURIComponent(path)}?ref=${GITHUB.branch}`;
      const res = await fetch(url, {headers:{Accept:"application/vnd.github.v3+json"}});
      if (!res.ok) throw new Error("Falha GitHub contents: " + path);
      return res.json();
    }

    async function walkTree(basePath="", acc=[]){
      const items = await fetchDir(basePath);
      for (const it of items){
        if (it.type === "dir"){
          if (EXCLUDE_FOLDERS.has(it.name)) continue;
          await walkTree(it.path, acc);
        } else if (it.type === "file"){
          const n = it.name.toLowerCase();
          if (!n.endsWith(".html")) continue;
          if (EXCLUDE_FILES.has(it.name)) continue;
          const cat = normalizeCategoryFromPath(it.path);
          if (!cat) continue; // ignora fora das 5 categorias
          acc.push(it.path);
        }
      }
      return acc;
    }

    async function readHtmlTitle(url){
      try{
        const r = await fetch(url,{cache:"no-store"});
        if(!r.ok) return null;
        const tx = await r.text();
        const m = tx.match(/<title[^>]*>([\s\S]*?)<\/title>/i);
        return m ? m[1].trim() : null;
      }catch{ return null; }
    }

    async function buildFromGitHub(){
      openProgress("Lendo estrutura do GitHub‚Ä¶");
      const files = await walkTree("");
      if (files.length===0) throw new Error("Nenhum jogo (.html) encontrado nas 5 categorias.");

      indexEntries = [];
      presentCategories = new Set();
      let done=0;

      for (const filePath of files){
        const cat = normalizeCategoryFromPath(filePath);
        if(!cat) continue;
        presentCategories.add(cat);

        const title = await readHtmlTitle(toRawUrl(filePath))
                    || filePath.split("/").pop().replace(/\.html?$/i,"");

        indexEntries.push({ category:cat, path:filePath, title, href:filePath });
        done++;
        if (done%5===0) updateProgress(Math.round((done/files.length)*100), `Indexando (${done}/${files.length})‚Ä¶`);
      }
      updateProgress(100,"Conclu√≠do!");
      closeProgress();
    }

    async function buildFromManifest(){
      openProgress("Lendo games-manifest.json local‚Ä¶");
      const res = await fetch("games-manifest.json",{cache:"no-store"});
      if(!res.ok) throw new Error("games-manifest.json n√£o encontrado.");
      const manifest = await res.json();
      const files = (manifest.entries||[]).map(e=>e.path).filter(p=>p.toLowerCase().endsWith(".html") && !/\/?index\.html?$/i.test(p));
      if (files.length===0) throw new Error("Manifest sem arquivos .html v√°lidos.");

      indexEntries = [];
      presentCategories = new Set();
      let done=0;

      for (const filePath of files){
        const cat = normalizeCategoryFromPath(filePath);
        if(!cat) { continue; } // ignora fora das 5 categorias
        presentCategories.add(cat);

        const title = await readHtmlTitle(filePath)
                    || filePath.split("/").pop().replace(/\.html?$/i,"");
        indexEntries.push({ category:cat, path:filePath, title, href:filePath });
        done++;
        if (done%5===0) updateProgress(Math.round((done/files.length)*100), `Indexando (${done}/${files.length})‚Ä¶`);
      }
      updateProgress(100,"Conclu√≠do!");
      closeProgress();
    }

    async function buildIndex(){
      try{
        if (USE_GITHUB_INDEX) await buildFromGitHub();
        else await buildFromManifest();
      }catch(e){
        console.warn(e);
        if (USE_GITHUB_INDEX){
          try{
            await buildFromManifest();
            showMsg("Sem GitHub. Usei o manifest local. üìÑ");
          }catch(e2){
            alert("N√£o foi poss√≠vel construir o √≠ndice (GitHub e manifest local indispon√≠veis).");
          }
        }else{
          alert("N√£o foi poss√≠vel construir o √≠ndice a partir do manifest local.");
        }
      }
      renderFilters();
      renderCatalog();
      showMsg("√çndice atualizado! ‚úÖ");
    }

    /* =======================
       RENDERIZA√á√ÉO
       ======================= */

    function renderFilters(){
      // popula select apenas com categorias presentes e v√°lidas
      const cats = CATEGORY_ORDER.filter(c=>presentCategories.has(c));
      categoryFilterEl.innerHTML = `<option value="">Todas</option>` +
        cats.map(c=>`<option value="${c}">${escapeHtml(CATEGORY_LABELS[c])}</option>`).join("");
    }

    function groupByCategory(entries){
      const map = new Map();
      for (const e of entries){
        if (!map.has(e.category)) map.set(e.category, []);
        map.get(e.category).push(e);
      }
      // ordena por t√≠tulo dentro de cada grupo
      for (const [k,arr] of map){ arr.sort((a,b)=>a.title.localeCompare(b.title,'pt-BR')); }
      return map;
    }

    function renderCatalog(){
      const q = (qEl.value||"").trim().toUpperCase();
      const catFilter = categoryFilterEl.value;

      let filtered = indexEntries.filter(e=>{
        const inCat = !catFilter || e.category===catFilter;
        const inText = !q || e.title.toUpperCase().includes(q) || e.path.toUpperCase().includes(q);
        return inCat && inText;
      });

      const grouped = groupByCategory(filtered);

      if (filtered.length===0){
        catalogEl.innerHTML = `
          <div class="text-center py-10 text-white/95">
            <div class="text-5xl mb-3">üòî</div>
            <p class="text-2xl font-bold drop-shadow">Nenhum jogo encontrado</p>
            <p>Tente alterar os filtros ou a palavra-chave.</p>
          </div>`;
        return;
      }

      const sections = [];
      for (const cat of CATEGORY_ORDER){
        if (!grouped.has(cat)) continue;
        const items = grouped.get(cat);
        sections.push(`
          <section class="bg-white/90 backdrop-blur-sm rounded-3xl p-6 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-2xl font-bold text-purple-700">${escapeHtml(CATEGORY_LABELS[cat])}</h3>
              <span class="text-sm text-gray-600">${items.length} jogo(s)</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              ${items.map(renderCard).join("")}
            </div>
          </section>
        `);
      }
      catalogEl.innerHTML = sections.join("\n");
    }

    function renderCard(item){
      return `
        <a href="${encodeURI(item.href)}" class="card block" title="${escapeHtml(item.path)}">
          <div class="text-4xl mb-2">üéÆ</div>
          <h4 class="text-lg font-bold mb-1">${escapeHtml(item.title)}</h4>
          <p class="text-[11px] opacity-90">${escapeHtml(item.path)}</p>
        </a>
      `;
    }

    /* =======================
       EVENTOS
       ======================= */
    qEl.addEventListener("input", renderCatalog);
    categoryFilterEl.addEventListener("change", renderCatalog);
    clearBtn.addEventListener("click", ()=>{ qEl.value=""; categoryFilterEl.value=""; renderCatalog(); });
    reindexBtn.addEventListener("click", buildIndex);

    // start
    buildIndex();
  </script>
</body>
</html>
